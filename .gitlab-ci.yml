image: docker-registry.booking.com/itsba/azure-deploy
stages:
   - build
   - deploy
  
build:
  stage: build
  tags:
    - docker
  script: 
     - /root/dotnet/dotnet build
     - cd UnitTest
     - /root/dotnet/dotnet test UnitTest.csproj

deploy-nuget:
  stage: deploy
  tags:
    - docker 
  script: 
    - cd Booking.Common.Http
    - mkdir /root/nupkgs
    - sed -i 's/<PackageVersion>1.0.0/<PackageVersion>'1.$(date -d 'now' '+%Y.%m.%d%H%M')'/g' Booking.Common.Http.csproj 
    - /root/dotnet/dotnet pack Booking.Common.Http.csproj --configuration Release --output /root/nupkgs
    - for fn in `find /root/nupkgs/ -name "*.nupkg"`; do
        
            /root/dotnet/dotnet nuget push $fn -k 4d0eae47-22b8-3c85-8b1c-b9bba1b1de36 -s https://nexus.booking.com/nexus/service/local/nuget/nuget-releases &
  
        done
    - wait
    
  environment: production
